<!DOCTYPE html>
<html>
	<head>
		<link rel="stylesheet" type="text/css" href="style.css">
		<link rel="icon" href="icon.png">
		<title>Challenge Master</title>
		<script src="https://www.gstatic.com/firebasejs/4.8.1/firebase.js"></script>
		<script src="https://www.gstatic.com/firebasejs/4.8.1/firebase-app.js"></script>
		<script src="https://www.gstatic.com/firebasejs/4.8.1/firebase-auth.js"></script>
		<script src="https://www.gstatic.com/firebasejs/4.8.1/firebase-database.js"></script>
		<script>
			var config = {
    			apiKey: "AIzaSyDCEk4vF4WeVLmYIorsXZuMwvMDDLJC5xs",
    			authDomain: "challenge-master.firebaseapp.com",
    			databaseURL: "https://challenge-master.firebaseio.com",
    			projectId: "challenge-master",
    			storageBucket: "challenge-master.appspot.com",
    			messagingSenderId: "378652612392"
  			};
  			firebase.initializeApp(config);
  		</script></head>
	<body link="black" vlink="black" alink="black">
		<div id="titleContainer">
			<H1 id="title">Challenge Master</H1>
			<a href="index.html" style="text-decoration:none"><H2 id="titleNavigation">Scoreboard</H2></a>
			<a href="browse.html" style="text-decoration:none"><H2 id="titleNavigation">Challenges</H2></a>
			<a href="upload.html" style="text-decoration:none"><H2 id="titleNavigation">Upload</H2></a>
			<a href="info.html" style="text-decoration:none"><H2 id="titleNavigation">Info</H2></a>
			<H2 id="signIn" onclick="signIn()">Sign In</H2>
			<H3 id="userInfo" onclick="viewProfile()"></H3></div>
		<div id="editUserContainer" style="border-bottom:2px solid black;">
			<H2>Profile</H2>
			<input id="userNameChange" maxlength="36" type="text">
			<button id="userNameChangeButton" onclick="updateDisplayName()">Update</button></div>
		<div id="userSolvesContainer" style="border-bottom:1px solid black;">
			<H2 id="userSolveCount">Solved 0 Challenges</h2>
			<div id="userSolves" style="border-top:2px solid black;"></div></div>
		<div id="userCreatedChallengesContainer">
			<H2 id="userCreatedCount">Created 0 Challenges</h2>
			<div id="userCreatedChallenges" style="border-top:2px solid black;"></div></div>		
		<div id="footerContainer" style="border-top:2px solid black;">
 				<a href="https://discord.gg/8h7HU4C" rel="noopener noreferrer" target="_blank" style="text-decoration:none"><H2 id="footerNavigation">Discord</H2></a>
 				<a href="https://github.com/Dan-McL/Challenge-Master" rel="noopener noreferrer" target="_blank" style="text-decoration:none"><H2 id="footerNavigation">GitHub</H2></a>
				<a href="https://twitter.com/CyberDiscUK" rel="noopener noreferrer" target="_blank" style="text-decoration:none"><H2 id="footerNavigation">Official Twitter</H2></a>
 				<a href="https://joincyberdiscovery.com/" rel="noopener noreferrer" target="_blank" style="text-decoration:none"><H2 id="footerNavigation">Cyber Discovery</H2></a><br><br>
 				<a href="https://raw.githubusercontent.com/Dan-McL/Challenge-Master/master/LICENSE" rel="noopener noreferrer" target="_blank"><p4>Copyright (c) 2017 Daniel</p4></a></div>
		<script>
			//Does Auth Stuff
  			firebase.auth().getRedirectResult().then(function(result) {
  				if (result.credential) {
    				var token = result.credential.accessToken;
  				}
  				var user = result.user;
			}).catch(function(error) {
  				var errorCode = error.code;
  				var errorMessage = error.message;
  				console.log(errorMessage)
  			});

			//Inits Page
			setUserData();
			loadUserData();

			function loadUserData() {
				//Redirect If Needed
				var uid = getParameterByName("uid");
				if (uid === null) {
					document.location.href = "index.html";
				}
				//Get User
				var database = firebase.database();
				database.ref("/users/" + uid).once("value").then((userSnapshot) => {
					document.getElementById("userNameChange").value = userSnapshot.val().name;
				});

				//Get Solves
				var solvesContainer = document.getElementById("userSolvesContainer");
				database.ref("/users/" + uid + "/solves").once("value").then((solvesSnapshot) => {
					var numSolves = 0;
					solvesSnapshot.forEach(function(solveSnapshot) {
						numSolves = numSolves + 1;
						database.ref("/challenges/" + solveSnapshot.key).once("value").then((challengeSnapshot) => {
							//Loops Through Creating HTML
			              	var title = challengeSnapshot.val().challengeTitle;
			              	var description = challengeSnapshot.val().challengeDescription;
			              	var solves = challengeSnapshot.val().challengeSolved;
			              	//Adds HTML to challenges.innerHTML
			              	database.ref("/users/" + challengeSnapshot.val().challengeCreator + "/name").once("value").then((userSnapshot) => {
				              	var html = "<div style=\"border-bottom: 1px solid black;\"><a href=\"challenge.html?cid=" + challengeSnapshot.key + "\"><H3>" + title + "</H3></a><H4>" + description + "</H4><p4>Created By<b> " + userSnapshot.val() + "</b>, Solved " + solves + " Times</p4></div>";
				              	solvesContainer.innerHTML = solvesContainer.innerHTML + html;
			              	});
						});
					});
					document.getElementById("userSolveCount").innerHTML = "Solved " + String(numSolves) + " Challenges";
				});

				//Get Challenges
				var challengesContainer = document.getElementById("userCreatedChallenges");
				database.ref("/users/" + uid + "/created").once("value").then((createsSnapshot) => {
					var numCreates = 0;
					createsSnapshot.forEach(function(createSnapshot) {
						numCreates = numCreates + 1;
						database.ref("/challenges/" + createSnapshot.val()).once("value").then((createChallengeSnapshot) => {
							//Loops Through Creating HTML
			              	var title = createChallengeSnapshot.val().challengeTitle;
			              	var description = createChallengeSnapshot.val().challengeDescription;
			              	var solves = createChallengeSnapshot.val().challengeSolved;
			              	//Adds HTML to challenges.innerHTML
			              	console.log(createChallengeSnapshot.key);
			              	var html = "<div style=\"border-bottom: 1px solid black;\"><a href=\"challenge.html?cid=" + createChallengeSnapshot.key + "\"><H3>" + title + "</H3></a><H4>" + description + "</H4><p4>Solved " + solves + " Times, <a href=\"edit.html?cid=" + createChallengeSnapshot.key + "\">edit</a></p4></div>";
			              	challengesContainer.innerHTML = challengesContainer.innerHTML + html;
						});
					});
					document.getElementById("userCreatedCount").innerHTML = "Created " + String(numCreates) + " Challenges";
				});
				return true;
			}

			function getParameterByName(name, url) {
	    		if (!url) url = window.location.href;
	    			name = name.replace(/[\[\]]/g, "\\$&");
	    			var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
	        		results = regex.exec(url);
	    		if (!results) return null;
	    		if (!results[2]) return '';
	    		return decodeURIComponent(results[2].replace(/\+/g, " "));
			}

			function updateDisplayName() {
		        firebase.auth().currentUser.getIdToken(true).then(function(token) {
		          document.getElementById("userNameChangeButton").disabled = true;
		          var req = new XMLHttpRequest();
		          req.open('GET', "https://us-central1-challenge-master.cloudfunctions.net/updateUser");
		          req.onload = function() {
		            //On Load redirect to challenge page
		            alert(req.response);
		            document.getElementById("userNameChangeButton").disabled = false;
		          }.bind(this);
		          req.setRequestHeader('Authorization', 'Bearer ' + token);
		          req.setRequestHeader('Name', document.getElementById("userNameChange").value);
		          req.send();
		        });    
		    }

			function viewProfile() {
				document.location.href = "user.html?uid=" + firebase.auth().currentUser.uid;
			}

  			function signIn() {
  				var display = document.getElementById("signIn").innerHTML;
  				if (display === "Sign Out") {
  					//Sign Out
  					firebase.auth().signOut();
  					document.getElementById("signIn").innerHTML = "Sign In";
  				}else {
  					//Sign In
  					var provider = new firebase.auth.GithubAuthProvider();
  					firebase.auth().signInWithRedirect(provider);
  				}	
  			}

  			function setUserData() {
				//Displays User Info
				firebase.auth().onAuthStateChanged(function(user) {
  					if (user) {
    					// User is signed in.
    					var uid = user.uid;
  						var database = firebase.database();
  						database.ref("/users/" + uid).once("value").then((snapshot) => {
  							var name = snapshot.val().name;
    						var score = snapshot.val().score;
    						var display = name + " - " + score;
							document.getElementById("userInfo").innerHTML = display;
							document.getElementById("signIn").innerHTML = "Sign Out";
							return display;
  						});
 					} else {
    					// No user is signed in.
    					document.getElementById("userInfo").innerHTML = "";
  					}
				});		
			}
  			</script>
		</body>
</html>