<!DOCTYPE html>
<html>
	<head>
		<link rel="stylesheet" type="text/css" href="style.css">
		<link rel="icon" href="icon.png">
		<title>Challenge Master</title>
		<script src="https://www.gstatic.com/firebasejs/4.8.1/firebase.js"></script>
		<script src="https://www.gstatic.com/firebasejs/4.8.1/firebase-app.js"></script>
		<script src="https://www.gstatic.com/firebasejs/4.8.1/firebase-auth.js"></script>
		<script src="https://www.gstatic.com/firebasejs/4.8.1/firebase-database.js"></script>
		<script>
			var config = {
    			apiKey: "AIzaSyDCEk4vF4WeVLmYIorsXZuMwvMDDLJC5xs",
    			authDomain: "challenge-master.firebaseapp.com",
    			databaseURL: "https://challenge-master.firebaseio.com",
    			projectId: "challenge-master",
    			storageBucket: "challenge-master.appspot.com",
    			messagingSenderId: "378652612392"
  			};
  			firebase.initializeApp(config);
  		</script></head>
	<body link="black" vlink="black" alink="black">
		<div id="titleContainer">
			<H1>Challenge Master</H1>
			<a class="titleNavLink" href="index.html"><H2 class="titleNav">Scoreboard</H2></a>
			<a class="titleNavLink" href="browse.html"><H2 class="titleNav">Challenges</H2></a>
			<a class="titleNavLink" href="upload.html"><H2 class="titleNav">Upload</H2></a>
			<a class="titleNavLink" href="info.html"><H2 class="titleNav">Info</H2></a>
			<H2 class="titleNav" id="signIn" onclick="signIn()">Sign In</H2>
			<H3 class="titleNav" id="userInfo" onclick="viewProfile()"></H3></div>
		<div>
			<h2>Messaging Test</h2>
			<p1>Message:</p1>
			<input id="message">
			<button onclick="send()">Send</button></div>
		<div id="messages">
			<H2>Messages:</H2></div>
		<div class="footerContainer">
 			<a class="footerNavLink" href="https://discord.gg/8h7HU4C" rel="noopener noreferrer" target="_blank"><H2 class="footerNav">Discord</H2></a>
 			<a class="footerNavLink" href="https://github.com/Dan-McL/Challenge-Master" rel="noopener noreferrer" target="_blank"><H2 class="footerNav">GitHub</H2></a>
			<a class="footerNavLink" href="https://twitter.com/CyberDiscUK" rel="noopener noreferrer" target="_blank"><H2 class="footerNav">Official Twitter</H2></a>
 			<a class="footerNavLink" href="https://joincyberdiscovery.com/" rel="noopener noreferrer" target="_blank"><H2 class="footerNav">Cyber Discovery</H2></a><br><br>
 			<a class="footerNavLink" href="https://raw.githubusercontent.com/Dan-McL/Challenge-Master/master/LICENSE" rel="noopener noreferrer" target="_blank"><p4>Copyright (c) 2017 Daniel</p4></a></div>
		<script>
			//Does Auth Stuff
  			firebase.auth().getRedirectResult().then(function(result) {
  				if (result.credential) {
    				var token = result.credential.accessToken;
  				}
  				var user = result.user;
			}).catch(function(error) {
  				var errorCode = error.code;
  				var errorMessage = error.message;
  				console.log(errorMessage)
  			});

			//Inits Page
			setUserData();
			loadMsgs();

			function viewProfile() {
				document.location.href = "user.html?uid=" + firebase.auth().currentUser.uid;
			}

  			function signIn() {
  				var display = document.getElementById("signIn").innerHTML;
  				if (display === "Sign Out") {
  					//Sign Out
  					firebase.auth().signOut();
  					document.getElementById("signIn").innerHTML = "Sign In";
  				}else {
  					//Sign In
  					var provider = new firebase.auth.GithubAuthProvider();
  					firebase.auth().signInWithRedirect(provider);
  				}	
  			}

  			function setUserData() {
				//Displays User Info
				firebase.auth().onAuthStateChanged(function(user) {
  					if (user) {
    					// User is signed in.
    					var uid = user.uid;
  						var database = firebase.database();
  						database.ref("/users/" + uid).once("value").then((snapshot) => {
  							var name = snapshot.val().name;
    						var score = snapshot.val().score;
    						var display = name + " - " + score;
							document.getElementById("userInfo").innerHTML = display;
							document.getElementById("signIn").innerHTML = "Sign Out";
							return display;
  						});
 					} else {
    					// No user is signed in.
    					document.getElementById("userInfo").innerHTML = "";
  					}
				});		
			}

			function send() {
				var user = firebase.auth().currentUser;
				var name = user.uid;
				var database = firebase.database();
				database.ref('/users/').child(name).once('value').then(usnapshot => {
					name = usnapshot.val().name; 
					var input = document.getElementById("message");
					var message = escape(input.value + "");
					input.value = "";
					var key = database.ref('/chat/').push().key;
					database.ref('/chat/').child(key).set(name + ": " + message);
				});
			}

			function loadMsgs() {
				var database = firebase.database();
				var messages = document.getElementById('messages');
				database.ref('/chat/').on('value', (snapshot) => {
					displayMsgs(snapshot, messages);
				});
			}

			function displayMsgs(snapshot, element) {
				var current = element.innerHTML;
				snapshot.forEach(child => {
					element.innerHTML = current + escape(child.val() + "") + "<br>";
				});
			}

			function escape(str) {
  				return str.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#x27;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\//g, '&#x2F;').replace(/\\/g, '&#x5C;').replace(/`/g, '&#96;');
			}
  			</script>
		</body>
</html>